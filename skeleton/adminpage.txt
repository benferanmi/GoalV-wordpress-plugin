<?php
/**
 * Admin Settings Page Template - Complete Skeleton
 * This skeleton provides the structure for the football voting plugin admin interface
 */

if (!defined('ABSPATH')) {
    exit;
}
?>

<div class="wrap">
    <!-- Page Title and WordPress Settings Integration -->
    <h1><?php echo esc_html(get_admin_page_title()); ?></h1>
    
    <!-- Display WordPress settings errors/success messages -->
    <?php settings_errors(); ?>
    
    <!-- Main Settings Form - WordPress Settings API Integration -->
    <form method="post" action="options.php">
        <?php
        // WordPress settings fields registration
        settings_fields('goalv_settings');
        ?>
        
        <div class="goalv-admin-sections">
            
            <!-- ============= API CONFIGURATION SECTION ============= -->
            <div class="goalv-admin-section">
                <h2><?php _e('API Configuration', 'goalv'); ?></h2>
                
                <!-- Football-Data.org API Key Management -->
                <table class="form-table">
                    <tr>
                        <!-- API Key Input with Show/Hide Toggle -->
                        <th scope="row">
                            <label for="goalv_api_key"><?php _e('Football-Data.org API Key', 'goalv'); ?></label>
                        </th>
                        <td>
                            <!-- 
                            Implementation: 
                            - Password field with show/hide button
                            - Gets option value with get_option('goalv_api_key', '')
                            - JavaScript toggle for password visibility
                            - Help text with registration link
                            -->
                        </td>
                    </tr>
                    
                    <!-- Competition Selection Dropdown -->
                    <tr>
                        <th scope="row">
                            <label for="goalv_competition_id"><?php _e('Competition', 'goalv'); ?></label>
                        </th>
                        <td>
                            <!-- 
                            Implementation:
                            - Dropdown with predefined competitions array
                            - Premier League, La Liga, Bundesliga, Serie A, Ligue 1, Champions League
                            - Uses get_option('goalv_competition_id', '2021') for current value
                            - selected() function for dropdown state
                            -->
                        </td>
                    </tr>
                </table>
            </div>

            <!-- ============= MATCH SYNCHRONIZATION SECTION ============= -->
            <div class="goalv-admin-section">
                <h2><?php _e('Match Synchronization', 'goalv'); ?></h2>
                
                <!-- Week Selection and Sync Controls -->
                <div class="goalv-sync-section">
                    <!-- 
                    Implementation:
                    - GoalV_API class integration for week data
                    - get_current_football_week() method call
                    - get_available_weeks() method call
                    - Dropdown for manual week selection vs auto-detect
                    -->
                    
                    <table class="form-table">
                        <tr>
                            <!-- Game Week Selector -->
                            <th scope="row">
                                <label for="sync_week_selector"><?php _e('Select Game Week', 'goalv'); ?></label>
                            </th>
                            <td>
                                <!-- Week selection dropdown with auto-detect option -->
                            </td>
                        </tr>
                    </table>
                    
                    <!-- Sync Control Buttons -->
                    <div class="goalv-sync-controls">
                        <!-- 
                        Implementation:
                        - Sync Matches button with AJAX handler
                        - Test API Connection button
                        - Loading spinner integration
                        - Result display area
                        -->
                    </div>
                    
                    <!-- Last Sync Information Display -->
                    <div id="sync-result">
                        <!-- 
                        Implementation:
                        - Shows last sync time from get_option('goalv_last_sync_time')
                        - Shows last synced week from get_option('goalv_last_synced_week')
                        - Formatted with WordPress date functions
                        -->
                    </div>
                </div>
            </div>
            
            <!-- ============= CURRENT WEEK STATUS SECTION ============= -->
            <div class="goalv-admin-section">
                <h2><?php _e('Current Week Status', 'goalv'); ?></h2>
                
                <!-- Status Information Table -->
                <table class="goalv-status-table">
                    <!-- Current Football Week Display -->
                    <tr>
                        <td><strong><?php _e('Current Football Week', 'goalv'); ?></strong></td>
                        <td>
                            <!-- 
                            Implementation:
                            - Shows current week from API call
                            - Format: GW{week_number}
                            -->
                        </td>
                    </tr>
                    
                    <!-- Last Synced Week Display -->
                    <tr>
                        <td><strong><?php _e('Last Synced Week', 'goalv'); ?></strong></td>
                        <td>
                            <!-- 
                            Implementation:
                            - Shows last synced week from options
                            - "Never synced" fallback message
                            -->
                        </td>
                    </tr>
                    
                    <!-- Current Week Matches Count -->
                    <tr>
                        <td><strong><?php _e('Matches This Week', 'goalv'); ?></strong></td>
                        <td>
                            <!-- 
                            Implementation:
                            - get_posts() query for goalv_matches post type
                            - Meta query for current week matches
                            - Count display
                            -->
                        </td>
                    </tr>
                </table>
            </div>

            <!-- ============= HOMEPAGE DISPLAY SETTINGS SECTION ============= -->
            <div class="goalv-admin-section">
                <h2><?php _e('Homepage Display Settings', 'goalv'); ?></h2>
                
                <!-- Week Display Mode Selection -->
                <table class="form-table">
                    <tr>
                        <th scope="row">
                            <label for="goalv_homepage_week_mode"><?php _e('Homepage Week Selection', 'goalv'); ?></label>
                        </th>
                        <td>
                            <!-- 
                            Implementation:
                            - Radio buttons for three modes:
                              1. Current Week Only
                              2. Custom Selected Weeks  
                              3. Week Range
                            - Uses get_option('goalv_homepage_week_mode', 'current')
                            - JavaScript show/hide for conditional fields
                            -->
                        </td>
                    </tr>
                    
                    <!-- Custom Weeks Selection (Conditional) -->
                    <tr id="custom-weeks-row">
                        <th scope="row">
                            <label for="goalv_homepage_weeks"><?php _e('Select Weeks to Display', 'goalv'); ?></label>
                        </th>
                        <td>
                            <!-- 
                            Implementation:
                            - Checkbox list of available weeks
                            - Scrollable container for many weeks
                            - get_option('goalv_homepage_weeks', array()) for selected weeks
                            - JavaScript show/hide based on mode selection
                            -->
                        </td>
                    </tr>
                    
                    <!-- Week Range Selection (Conditional) -->
                    <tr id="week-range-row">
                        <th scope="row">
                            <label><?php _e('Week Range', 'goalv'); ?></label>
                        </th>
                        <td>
                            <!-- 
                            Implementation:
                            - Two dropdown selectors (start/end)
                            - get_option('goalv_homepage_range_start') and range_end
                            - JavaScript show/hide based on mode selection
                            -->
                        </td>
                    </tr>
                    
                    <!-- Display Options -->
                    <tr>
                        <th scope="row">
                            <label for="goalv_show_week_headers"><?php _e('Display Options', 'goalv'); ?></label>
                        </th>
                        <td>
                            <!-- 
                            Implementation:
                            - Checkbox for week headers display
                            - Checkbox for fallback when no matches
                            - get_option() calls for current values
                            -->
                        </td>
                    </tr>
                </table>
                
                <!-- Live Preview Section -->
                <div class="goalv-preview-section">
                    <!-- 
                    Implementation:
                    - JavaScript-powered preview updates
                    - Shows which weeks will be displayed
                    - Updates in real-time as settings change
                    -->
                </div>
            </div>
            
            <!-- ============= VOTING CONFIGURATION SECTION ============= -->
            <div class="goalv-admin-section">
                <h2><?php _e('Voting Configuration', 'goalv'); ?></h2>
                
                <table class="form-table">
                    <!-- General Voting Settings -->
                    <tr>
                        <th scope="row"><?php _e('General Voting Settings', 'goalv'); ?></th>
                        <td>
                            <!-- 
                            Implementation:
                            - Checkbox for allowing vote changes
                            - get_option('goalv_allow_vote_change', 'yes')
                            - Help text explaining functionality
                            -->
                        </td>
                    </tr>
                    
                    <!-- Location-Specific Settings -->
                    <tr>
                        <th scope="row"><?php _e('Location-Specific Settings', 'goalv'); ?></th>
                        <td>
                            <!-- 
                            Implementation:
                            - Separate checkboxes for homepage and details page
                            - get_option calls for homepage and details vote change settings
                            - Conditional enabling based on general setting
                            -->
                        </td>
                    </tr>

                    <!-- Multiple Votes Settings -->
                    <tr>
                        <th scope="row"><?php _e('Multiple Votes Settings', 'goalv'); ?></th>
                        <td>
                            <!-- 
                            Implementation:
                            - Checkbox for multiple votes per match
                            - get_option('goalv_allow_multiple_votes', 'no')
                            - Explanation of single vs multiple vote modes
                            -->
                        </td>
                    </tr>
                </table>
            </div>

            <!-- ============= CATEGORY MANAGEMENT SECTION ============= -->
            <div class="goalv-admin-section">
                <h2><?php _e('Prediction Categories Management', 'goalv'); ?></h2>
                
                <!-- Add New Category Form -->
                <div class="goalv-add-category-form">
                    <!-- 
                    Implementation:
                    - Form inputs for category key and label
                    - Validation for key format (lowercase, underscores)
                    - AJAX submission to goalv_add_category action
                    - Loading spinner and error handling
                    -->
                </div>
                
                <!-- Existing Categories Management -->
                <div class="goalv-categories-list">
                    <!-- 
                    Implementation:
                    - GoalV_Voting()->get_available_categories() call
                    - Sortable list with drag-and-drop reordering
                    - Edit/Delete actions for each category
                    - Protection for 'other' category (cannot be deleted)
                    - Usage count display for each category
                    - AJAX handlers for CRUD operations
                    -->
                </div>
                
                <!-- Category Information Section -->
                <div class="goalv-category-info">
                    <!-- 
                    Implementation:
                    - Help text explaining category functionality
                    - Usage guidelines and limitations
                    - Explanation of default vs custom categories
                    -->
                </div>
            </div>

            <!-- ============= TEMPLATE LABELS SECTION ============= -->
            <div class="goalv-admin-section">
                <h2><?php _e('Template Labels', 'goalv'); ?></h2>
                
                <!-- Custom Label Inputs -->
                <table class="form-table">
                    <!-- 
                    Implementation:
                    - Text inputs for each template label:
                      - Teams Label
                      - Score Label  
                      - Status Label
                      - Date Label
                      - Predictions Label
                      - Details Label
                    - get_option() calls for current values
                    - Placeholder text showing defaults
                    - Help text explaining usage
                    -->
                </table>
                
                <!-- Usage Examples -->
                <div class="goalv-label-examples">
                    <!-- 
                    Implementation:
                    - Code examples showing shortcode usage
                    - Demonstrates both custom labels and admin defaults
                    - Help text for different scenarios
                    -->
                </div>
            </div>
            
            <!-- ============= SHORTCODE USAGE SECTION ============= -->
            <div class="goalv-admin-section">
                <h2><?php _e('Shortcode Usage', 'goalv'); ?></h2>
                
                <!-- Shortcode Documentation -->
                <div class="goalv-shortcode-examples">
                    <!-- 
                    Implementation:
                    - Documentation for available shortcodes:
                      - [goalv_matches] basic usage
                      - Template options (card, grid)
                      - Limit parameter
                      - Custom label parameters
                    - Code examples with descriptions
                    - Usage scenarios and best practices
                    -->
                </div>
            </div>
            
            <!-- ============= SYSTEM STATUS SECTION ============= -->
            <div class="goalv-admin-section">
                <h2><?php _e('System Status', 'goalv'); ?></h2>
                
                <!-- System Health Checks -->
                <table class="goalv-status-table">
                    <!-- API Connection Status -->
                    <tr>
                        <td><strong><?php _e('API Connection', 'goalv'); ?></strong></td>
                        <td>
                            <!-- 
                            Implementation:
                            - Check if API key is configured
                            - Success/error status display
                            - Color-coded status indicators
                            -->
                        </td>
                    </tr>
                    
                    <!-- Database Tables Status -->
                    <tr>
                        <td><strong><?php _e('Database Tables', 'goalv'); ?></strong></td>
                        <td>
                            <!-- 
                            Implementation:
                            - SHOW TABLES check for required tables
                            - goalv_vote_options and goalv_votes tables
                            - Success/error status display
                            -->
                        </td>
                    </tr>
                    
                    <!-- Total Matches Count -->
                    <tr>
                        <td><strong><?php _e('Total Matches', 'goalv'); ?></strong></td>
                        <td>
                            <!-- 
                            Implementation:
                            - wp_count_posts('goalv_matches') call
                            - Display published matches count
                            -->
                        </td>
                    </tr>
                    
                    <!-- Total Votes Count -->
                    <tr>
                        <td><strong><?php _e('Total Votes', 'goalv'); ?></strong></td>
                        <td>
                            <!-- 
                            Implementation:
                            - Direct database query to votes table
                            - COUNT(*) query with fallback to 0
                            -->
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        
        <!-- WordPress Settings API Submit Button -->
        <?php submit_button(); ?>
    </form>
</div>

<!-- ============= JAVASCRIPT FUNCTIONALITY ============= -->
<script>
jQuery(document).ready(function($) {
    
    // ===== API KEY VISIBILITY TOGGLE =====
    $('#toggle-api-key').on('click', function() {
        // Implementation: Toggle password field type between 'password' and 'text'
        // Update button text between 'Show' and 'Hide'
    });

    // ===== HOMEPAGE WEEK MODE HANDLING =====
    $('input[name="goalv_homepage_week_mode"]').change(function() {
        // Implementation: Show/hide conditional sections based on selected mode
        // - Show custom weeks checkboxes for 'custom' mode
        // - Show range selectors for 'range' mode
        // - Update preview in real-time
    });
    
    // ===== WEEK SELECTION CHANGE HANDLERS =====
    $('input[name="goalv_homepage_weeks[]"], select[name="goalv_homepage_range_start"], select[name="goalv_homepage_range_end"]').change(function() {
        // Implementation: Update preview when week selections change
    });
    
    // ===== PREVIEW UPDATE FUNCTION =====
    function updateHomepagePreview() {
        // Implementation: Calculate and display preview text showing which weeks will be shown
        // - Handle different modes (current, custom, range)
        // - Count selected weeks
        // - Show user-friendly preview message
    }
    
    // ===== CATEGORY MANAGEMENT FUNCTIONS =====
    
    // Make categories sortable with drag-and-drop
    if ($('#categories-sortable-list').length) {
        $('#categories-sortable-list').sortable({
            // Implementation: jQuery UI sortable with AJAX save on reorder
            // - Handle drag-and-drop reordering
            // - AJAX call to goalv_reorder_categories action
            // - Update display order numbers in real-time
        });
    }
    
    // Add new category handler
    $('#add-category-btn').on('click', function() {
        // Implementation: 
        // - Validate category key (lowercase, underscores only)
        // - Validate category label (not empty)
        // - AJAX call to goalv_add_category action
        // - Handle success/error responses
        // - Reload page on success to show new category
    });
    
    // Edit category handlers
    $('.goalv-edit-category').on('click', function() {
        // Implementation: Show edit form, hide display content
    });
    
    $('.cancel-category-edit').on('click', function() {
        // Implementation: Hide edit form, show display content
    });
    
    $('.save-category-edit').on('click', function() {
        // Implementation:
        // - Validate new label
        // - AJAX call to goalv_update_category action
        // - Update display on success
        // - Handle errors
    });
    
    // Delete category handler
    $('.goalv-delete-category').on('click', function() {
        // Implementation:
        // - Confirmation dialog
        // - AJAX call to goalv_delete_category action
        // - Remove from display on success
        // - Handle errors and restore button state
    });
    
    // ===== UTILITY FUNCTIONS =====
    
    // Allow Enter key to add category
    $('#new-category-key, #new-category-label').on('keypress', function(e) {
        // Implementation: Trigger add button click on Enter key press
    });
    
    // Initialize preview on page load
    updateHomepagePreview();
});
</script>